{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>SENSE | Video Call</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
  <link rel="stylesheet" href="{% static 'css/bot.css' %}">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

</head>

<body>

  <nav id="navbar">
    <h1>SENSE</h1>
    <div class="nav-right">
      <button class="nav-btn leave-btn">Leave Room</button>
    </div>
  </nav>

  <div class="page-container">

    <main class="main-content">
      <div id="meet">
      </div>
    </main>

    <aside class="tools-sidebar">

      <div class="tool-section" id="sign-language-tool">
        <h3>Sign Language</h3>
        <p>Real-time ASL detection.</p>
        <button id="toggle-sign-detection" class="tool-btn">Start Detection</button>
        <video id="sign-video-feed" width="300" height="225" muted playsinline autoplay
          style="display: none; border-radius: 8px; margin-top: 10px;"></video>
        
        <div id="sign-display-area"
          style="display: none; margin-top: 10px; max-height: 150px; overflow-y: auto; background: #f0f0f0; border-radius: 8px; padding: 10px;">
          <strong>Detected Signs:</strong>
          <ul id="sign-list" style="list-style: none; padding: 0; margin: 5px 0 0 0;"></ul>
        </div>

        <canvas id="sign-canvas" width="224" height="224" style="display: none;"></canvas>
      </div>


      <div class="tool-section" id="captions-tool">
        <h3>Live Captions (STT)</h3>
        <p>Transcribe spoken audio.</p>
        <div id="caption-controls">
          <select id="stt-language">
            <option value="en-IN">English</option>
            <option value="hi-IN">Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
            <option value="dgo-IN">Dogri (‡§°‡•ã‡§ó‡§∞‡•Ä / ⁄àŸà⁄Øÿ±€å)</option>
          </select>
          <div class="btn-group">
            <button id="start-stt" class="tool-btn">üé§ Start</button>
            <button id="stop-stt" class="tool-btn danger">üõë Stop</button>
          </div>
        </div>
        <div id="caption-overlay">üéô Press "Start" to begin...</div>
      </div>

      <div class="tool-section" id="tts-tool">
        <h3>Text-to-Speech (TTS)</h3>
        <p>Convert text into spoken audio.</p>
        <form id="ttsForm">
          <input type="text" id="textInput" placeholder="Enter text to speak..." required>
          <select id="langSelect">
            <option value="en">English</option>
            <option value="hi">Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
            <option value="sd">Sindhi (‡§∏‡§ø‡§®‡•ç‡§ß‡•Ä)</option>
          </select>
          <button type="submit" class="tool-btn primary">Speak Audio</button>
        </form>
        <audio id="audioPlayer"></audio>
      </div>

    </aside>
  </div>

  <button id="chat-toggle-icon" class="chat-toggle-icon">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
      <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" />
    </svg>
  </button>
  {% include 'partials/bot.html' %}
  <script src="https://8x8.vc/external_api.js"></script>
  <script src="{% static 'js/speech_overlay.js' %}"></script>
  <script src="{% static 'js/bot.js' %}"></script>

  <script>
    // ===== Initialize Jitsi Meet =====
    const domain = "8x8.vc";
    const jitsiRoomName = "vpaas-magic-cookie-d25168bf67bb49e1979fb170f4793d3c/SignMeetRoom"; // Ensure this matches your JWT/setup
    const jwt = "eyJraWQiOiJ2cGFhcy1tYWdpYy1jb29raWUtZDI1MTY4YmY2N2JiNDllMTk3OWZiMTcwZjQ3OTNkM2MvOWUwOTkwLVNBTVBMRV9BUFAiLCJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiJqaXRzaSIsImlzcyI6ImNoYXQiLCJpYXQiOjE3NjE1NTE2MjYsImV4cCI6MTc2MTU2MjgyNiwibmJmIjoxNzYxNTUxNjIxLCJzdWIiOiJ2cGFhcy1tYWdpYy1jb29raWUtZDI1MTY4YmY2N2JiNDllMTk3OWZiMTcwZjQ3OTNkM2MiLCJjb250ZXh0Ijp7ImZlYXR1cmVzIjp7ImxpdmVzdHJlYW1pbmciOnRydWUsImZpbGUtdXBsb2FkIjp0cnVlLCJvdXRib3VuZC1jYWxsIjp0cnVlLCJzaXAtb3V0Ym91bmQtY2FsbCI6ZmFsc2UsInRyYW5zY3JpcHRpb24iOnRydWUsImxpc3QtdmlzaXRvcnMiOmZhbHNlLCJyZWNvcmRpbmciOnRydWUsImZsaXAiOmZhbHNlfSwidXNlciI6eyJoaWRkZW4tZnJvbS1yZWNvcmRlciI6ZmFsc2UsIm1vZGVyYXRvciI6dHJ1ZSwibmFtZSI6IjFqdDIyY3MxMTYiLCJpZCI6Imdvb2dsZS1vYXV0aDJ8MTAxNTM3MzI5NTEwMjk3OTM3ODQ1IiwiYXZhdGFyIjoiIiwiZW1haWwiOiIxanQyMmNzMTE2QGp5b3RoeWl0LmFjLmluIn19LCJyb29tIjoiKiJ9.C_wE2w4XgO5R7u1fR3H0g_kL5pC6xZ7d8J9yG0aB1cE"; // Ensure JWT is valid or generated dynamically
    const options = {
      roomName: jitsiRoomName,
      jwt: jwt,
      parentNode: document.querySelector('#meet'),
      width: "100%",
      height: "100%", // Adjust if needed to fit layout
      configOverwrite: { prejoinPageEnabled: false },
      interfaceConfigOverwrite: {
        TOOLBAR_BUTTONS: [ // Customize Jitsi toolbar if desired
          'microphone', 'camera', 'closedcaptions', 'desktop', 'fullscreen',
          'fodeviceselection', 'hangup', 'profile', 'chat', 'recording',
          'livestreaming', 'etherpad', 'sharedvideo', 'settings', 'raisehand',
          'videoquality', 'filmstrip', 'invite', 'feedback', 'stats', 'shortcuts',
          'tileview', 'videobackgroundblur', 'download', 'help', 'mute-everyone',
          // 'security' // Consider security implications if enabling this
        ],
        DISABLE_DOMINANT_SPEAKER_INDICATOR: true
      }
    };
    const api = new JitsiMeetExternalAPI(domain, options);

    // TTS Form Submission Handler
    document.getElementById('ttsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = document.getElementById('textInput').value;
      const lang = document.getElementById('langSelect').value;
      const url = `/api/dynamic_tts/?text=${encodeURIComponent(text)}&lang=${lang}`;
      const audioPlayer = document.getElementById('audioPlayer');
      audioPlayer.src = url;
      audioPlayer.play().catch(err => console.warn("Autoplay blocked:", err));
    });


    // --- ‚≠êÔ∏è 3. SIGN LANGUAGE SCRIPT (HEAVILY REVISED) ‚≠êÔ∏è ---

    const signToggleButton = document.getElementById('toggle-sign-detection');
    const signVideoFeed = document.getElementById('sign-video-feed');
    const signCanvas = document.getElementById('sign-canvas');
    const signCtx = signCanvas.getContext('2d');

    // Get the CORRECT elements from the HTML
    const signDisplayArea = document.getElementById('sign-display-area');
    const signList = document.getElementById('sign-list');

    let signStream = null;
    let signInterval = null;

    signToggleButton.addEventListener('click', () => {
      if (signInterval) {
        // --- STOP DETECTION ---
        console.log("Stopping sign detection...");
        clearInterval(signInterval);
        signInterval = null;

        if (signStream) {
          signStream.getTracks().forEach(track => track.stop());
          signStream = null;
        }

        signVideoFeed.srcObject = null;
        signVideoFeed.style.display = 'none';
        signDisplayArea.style.display = 'none'; // Hide display area
        signList.innerHTML = ''; // Clear the list

        signToggleButton.innerText = 'Start Detection';
        signToggleButton.classList.remove('danger');

      } else {
        // --- START DETECTION ---
        console.log("Starting sign detection...");
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(stream => {
            signStream = stream;
            signVideoFeed.srcObject = stream;
            signVideoFeed.play();
            signVideoFeed.style.display = 'block';
            signDisplayArea.style.display = 'block'; // Show display area

            // Start capturing frames
            signInterval = setInterval(() => {
              // --- Crop video to square ---
              // Video is 300x225. We want the center 225x225 square.
              const videoWidth = signVideoFeed.videoWidth; // 300
              const videoHeight = signVideoFeed.videoHeight; // 225
              const size = Math.min(videoWidth, videoHeight); // 225
              const x = (videoWidth - size) / 2; // (300 - 225) / 2 = 37.5
              const y = (videoHeight - size) / 2; // (225 - 225) / 2 = 0
              
              // Draw the square crop onto the (now square) canvas
              signCtx.drawImage(
                signVideoFeed, // source
                x, y,          // source x, y
                size, size,    // source width, height
                0, 0,          // dest x, y
                signCanvas.width, signCanvas.height // dest width, height
              );
              
              const imgData = signCanvas.toDataURL('image/jpeg');

              // Send to backend (using jQuery $.post)
              $.post('/detect_sign/', { image: imgData }, function (response) {
                if (response.label) {
                  const lastSignItem = signList.querySelector('li:first-child');
                  const newSignText = `${response.label} (${response.confidence}%)`;
                  
                  // Only add if it's a new sign to prevent spam
                  if (!lastSignItem || lastSignItem.innerText !== newSignText) {
                      const newItem = document.createElement('li');
                      newItem.innerText = newSignText;
                      signList.prepend(newItem); // Add new sign to the top
                  }
                }
              }).fail(function (xhr) {
                console.error("Failed to post sign detection image. Status:", xhr.status, xhr.responseText);
                const lastSignItem = signList.querySelector('li:first-child');
                const errorText = 'Error (Connection failed)';

                if (!lastSignItem || lastSignItem.innerText !== errorText) {
                    const errorItem = document.createElement('li');
                    errorItem.style.color = 'red';
                    errorItem.innerText = errorText;
                    signList.prepend(errorItem);
                }
              });
            }, 1500); // Send every 1.5 seconds

            signToggleButton.innerText = 'Stop Detection';
            signToggleButton.classList.add('danger');

          })
          .catch(err => {
            console.error("Camera error:", err);
            alert("Could not access camera for sign detection. Please check permissions.");
          });
      }
    });
  </script>
</body>
</html>