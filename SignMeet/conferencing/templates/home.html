{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>SENSE | Video Call</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
  <link rel="stylesheet" href="{% static 'css/bot.css' %}">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>

  <nav id="navbar">
    <h1>SENSE</h1>
    <div class="nav-right">
      <button class="nav-btn leave-btn">Leave Room</button>
    </div>
  </nav>

  <div class="page-container">

    <main class="main-content">
      <div id="meet">
      </div>
    </main>

    <aside class="tools-sidebar">

      <div class="tool-section" id="sign-language-tool">
        <h3>Sign Language</h3>
        <p>Real-time ASL detection.</p>
        <button id="toggle-sign-detection" class="tool-btn">Start Detection</button>
        <video id="sign-video-feed" width="300" height="225" muted playsinline autoplay
          style="display: none; border-radius: 8px; margin-top: 10px;"></video>
        <div id="sign-display-area"
          style="display: none; margin-top: 10px; max-height: 150px; overflow-y: auto; background: #f0f0f0; border-radius: 8px; padding: 10px;">
          <strong>Detected Signs:</strong>
          <ul id="sign-list" style="list-style: none; padding: 0; margin: 5px 0 0 0;"></ul>
        </div>
        <canvas id="sign-canvas" width="200" height="150" style="display: none;"></canvas>
      </div>


      <div class="tool-section" id="captions-tool">
        <h3>Live Captions (STT)</h3>
        <p>Transcribe spoken audio.</p>
        <div id="caption-controls">
          <select id="stt-language">
            <option value="en-IN">English</option>
            <option value="hi-IN">Hindi (рд╣рд┐рдиреНрджреА)</option>
            <option value="bn-IN">Bengali (ржмрж╛ржВрж▓рж╛)</option>
            <option value="te-IN">Telugu (р░др▒Жр░▓р▒Бр░Чр▒Б)</option>
            <option value="mr-IN">Marathi (рдорд░рд╛рдареА)</option>
            <option value="ta-IN">Tamil (родрооро┐ро┤рпН)</option>
            <option value="ur-IN">Urdu (╪з╪▒╪п┘И)</option>
            <option value="gu-IN">Gujarati (ркЧрлБркЬрк░рк╛ркдрлА)</option>
            <option value="kn-IN">Kannada (р▓Хр▓ир│Нр▓ир▓б)</option>
            <option value="or-IN">Odia (рмУрмбрм╝рм┐рмЖ)</option>
            <option value="ml-IN">Malayalam (р┤ор┤▓р┤пр┤╛р┤│р┤В)</option>
            <option value="pa-IN">Punjabi (рикрй░риЬри╛римрйА)</option>
            <option value="as-IN">Assamese (ржЕрж╕ржорзАржпрж╝рж╛)</option>
            <option value="mai-IN">Maithili (рдореИрдерд┐рд▓реА)</option>
            <option value="sa-IN">Sanskrit (рд╕рдВрд╕реНрдХреГрддрдореН)</option>
            <option value="sat-IN">Santali (с▒ес▒Яс▒▒с▒Ыс▒Яс▒▓с▒д)</option>
            <option value="ks-IN">Kashmiri (рдХрд╢реНрдореАрд░реА / ┘Г╪┤┘Е┘К╪▒┘К)</option>
            <option value="ne-IN">Nepali (рдиреЗрдкрд╛рд▓реА)</option>
            <option value="sd-IN">Sindhi (рд╕рд┐рдиреНрдзреА / ╪│┘Ж┌М┘К)</option>
            <option value="kok-IN">Konkani (рдХреЛрдВрдХрдгреА)</option>
            <option value="mni-IN">Manipuri / Meitei (ржорзИрждрзИрж▓рзЛржирзН)</option>
            <option value="brx-IN">Bodo (рдмрд░'/рдмрдбрд╝реЛ)</option>
            <option value="dgo-IN">Dogri (рдбреЛрдЧрд░реА / ┌И┘И┌п╪▒█М)</option>
          </select>
          <div class="btn-group">
            <button id="start-stt" class="tool-btn">ЁЯОд Start</button>
            <button id="stop-stt" class="tool-btn danger">ЁЯЫС Stop</button>
          </div>
        </div>
        <div id="caption-overlay">ЁЯОЩ Press "Start" to begin...</div>
      </div>

      <div class="tool-section" id="tts-tool">
        <h3>Text-to-Speech (TTS)</h3>
        <p>Convert text into spoken audio.</p>
        <form id="ttsForm">
          <input type="text" id="textInput" placeholder="Enter text to speak..." required>
          <select id="langSelect">
            <option value="en">English</option>
            <option value="hi">Hindi (рд╣рд┐рдиреНрджреА)</option>
            <option value="bn">Bengali (ржмрж╛ржВрж▓рж╛)</option>
            <option value="te">Telugu (р░др▒Жр░▓р▒Бр░Чр▒Б)</option>
            <option value="mr">Marathi (рдорд░рд╛рдареА)</option>
            <option value="ta">Tamil (родрооро┐ро┤рпН)</option>
            <option value="ur">Urdu (╪з╪▒╪п┘И)</option>
            <option value="gu">Gujarati (ркЧрлБркЬрк░рк╛ркдрлА)</option>
            <option value="kn">Kannada (р▓Хр▓ир│Нр▓ир▓б)</option>
            <option value="or">Odia (рмУрмбрм╝рм┐рмЖ)</option>
            <option value="ml">Malayalam (р┤ор┤▓р┤пр┤╛р┤│р┤В)</option>
            <option value="pa">Punjabi (рикрй░риЬри╛римрйА)</option>
            <option value="as">Assamese (ржЕрж╕ржорзАржпрж╝рж╛)</option>
            <option value="sa">Sanskrit (рд╕рдВрд╕реНрдХреГрддрдореН)</option>
            <option value="ks">Kashmiri (рдХрд╢реНрдореАрд░реА)</option>
            <option value="ne">Nepali (рдиреЗрдкрд╛рд▓реА)</option>
            <option value="sd">Sindhi (рд╕рд┐рдиреНрдзреА)</option>
          </select>
          <button type="submit" class="tool-btn primary">Speak Audio</button>
        </form>
        <audio id="audioPlayer"></audio>
      </div>

    </aside>
  </div>

  <button id="chat-toggle-icon" class="chat-toggle-icon">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
      <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" />
    </svg>
  </button>
  {% include 'partials/bot.html' %}
  <script src="https://8x8.vc/external_api.js"></script>
  <script src="{% static 'js/speech_overlay.js' %}"></script>
  <script src="{% static 'js/bot.js' %}"></script>

  <script>
    // ===== Initialize Jitsi Meet =====
    const domain = "8x8.vc";
    const jitsiRoomName = "vpaas-magic-cookie-d25168bf67bb49e1979fb170f4793d3c/SignMeetRoom"; // Ensure this matches your JWT/setup
    const jwt = "eyJraWQiOiJ2cGFhcy1tYWdpYy1jb29raWUtZDI1MTY4YmY2N2JiNDllMTk3OWZiMTcwZjQ3OTNkM2MvOWUwOTkwLVNBTVBMRV9BUFAiLCJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiJqaXRzaSIsImlzcyI6ImNoYXQiLCJpYXQiOjE3NjE1NTE2MjYsImV4cCI6MTc2MTU2MjgyNiwibmJmIjoxNzYxNTUxNjIxLCJzdWIiOiJ2cGFhcy1tYWdpYy1jb29raWUtZDI1MTY4YmY2N2JiNDllMTk3OWZiMTcwZjQ3OTNkM2MiLCJjb250ZXh0Ijp7ImZlYXR1cmVzIjp7ImxpdmVzdHJlYW1pbmciOnRydWUsImZpbGUtdXBsb2FkIjp0cnVlLCJvdXRib3VuZC1jYWxsIjp0cnVlLCJzaXAtb3V0Ym91bmQtY2FsbCI6ZmFsc2UsInRyYW5zY3JpcHRpb24iOnRydWUsImxpc3QtdmlzaXRvcnMiOmZhbHNlLCJyZWNvcmRpbmciOnRydWUsImZsaXAiOmZhbHNlfSwidXNlciI6eyJoaWRkZW4tZnJvbS1yZWNvcmRlciI6ZmFsc2UsIm1vZGVyYXRvciI6dHJ1ZSwibmFtZSI6IjFqdDIyY3MxMTYiLCJpZCI6Imdvb2dsZS1vYXV0aDJ8MTAxNTM3MzI5NTEwMjk3OTM3ODQ1IiwiYXZhdGFyIjoiIiwiZW1haWwiOiIxanQyMmNzMTE2QGp5b3RoeWl0LmFjLmluIn19LCJyb29tIjoiKiJ9.C_wE2w4XgO5R7u1fR3H0g_kL5pC6xZ7d8J9yG0aB1cE"; // Ensure JWT is valid or generated dynamically
    const options = {
      roomName: jitsiRoomName,
      jwt: jwt,
      parentNode: document.querySelector('#meet'),
      width: "100%",
      height: "100%", // Adjust if needed to fit layout
      configOverwrite: { prejoinPageEnabled: false },
      interfaceConfigOverwrite: {
        TOOLBAR_BUTTONS: [ // Customize Jitsi toolbar if desired
          'microphone', 'camera', 'closedcaptions', 'desktop', 'fullscreen',
          'fodeviceselection', 'hangup', 'profile', 'chat', 'recording',
          'livestreaming', 'etherpad', 'sharedvideo', 'settings', 'raisehand',
          'videoquality', 'filmstrip', 'invite', 'feedback', 'stats', 'shortcuts',
          'tileview', 'videobackgroundblur', 'download', 'help', 'mute-everyone',
          // 'security' // Consider security implications if enabling this
        ],
        DISABLE_DOMINANT_SPEAKER_INDICATOR: true
      }
    };
    const api = new JitsiMeetExternalAPI(domain, options);

    // TTS Form Submission Handler
    document.getElementById('ttsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = document.getElementById('textInput').value;
      const lang = document.getElementById('langSelect').value;
      const url = `/api/dynamic_tts/?text=${encodeURIComponent(text)}&lang=${lang}`;
      const audioPlayer = document.getElementById('audioPlayer');
      audioPlayer.src = url;
      audioPlayer.play().catch(err => console.warn("Autoplay blocked:", err));
    });




    const signToggleButton = document.getElementById('toggle-sign-detection');
    const signVideoFeed = document.getElementById('sign-video-feed');
    const signCanvas = document.getElementById('sign-canvas');
    const signCtx = signCanvas.getContext('2d');

    // Get elements from the overlay
    const signOverlay = document.getElementById('sign-overlay');
    const signText = document.getElementById('predicted-sign');
    const confText = document.getElementById('sign-confidence');

    let signStream = null;
    let signInterval = null;

    signToggleButton.addEventListener('click', () => {
      if (signInterval) {
        // --- STOP DETECTION ---
        console.log("Stopping sign detection...");
        clearInterval(signInterval);
        signInterval = null;

        if (signStream) {
          signStream.getTracks().forEach(track => track.stop());
          signStream = null;
        }

        signVideoFeed.srcObject = null;
        signVideoFeed.style.display = 'none';
        signOverlay.style.display = 'none';

        signText.innerText = 'None';
        confText.innerText = '';

        signToggleButton.innerText = 'Start Detection';
        signToggleButton.classList.remove('danger');

      } else {
        // --- START DETECTION ---
        console.log("Starting sign detection...");
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(stream => {
            signStream = stream;
            signVideoFeed.srcObject = stream;
            signVideoFeed.play(); 
            signVideoFeed.style.display = 'block';
            signOverlay.style.display = 'block';

            // Start capturing frames
            signInterval = setInterval(() => {
              // Draw video frame to hidden canvas
              signCtx.drawImage(signVideoFeed, 0, 0, signCanvas.width, signCanvas.height);
              const imgData = signCanvas.toDataURL('image/jpeg');

              // Send to backend (requires jQuery)
              $.post('/conferencing/detect_sign/', { image: imgData }, function (response) {
                if (response.label) {
                  signText.innerText = response.label;
                  confText.innerText = `(${response.confidence}% confidence)`;
                } else {
                  signText.innerText = 'None';
                  confText.innerText = '';
                }
              }).fail(function () {
                console.error("Failed to post sign detection image.");
                signText.innerText = 'Error';
                confText.innerText = '(Connection failed)';
              });
            }, 3000); // every 3 seconds

            signToggleButton.innerText = 'Stop Detection';
            signToggleButton.classList.add('danger');

          })
          .catch(err => {
            console.error("Camera error:", err);
            alert("Could not access camera for sign detection. Please check permissions.");
          });
      }
    });
  </script>


</body>

</html>