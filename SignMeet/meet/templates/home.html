<!DOCTYPE html>
<html>

<head>
    <title>SENSE | Video Call</title>
</head>

<body style="background-color: #f5f5f5; text-align:center;">

    <h2>WELCOME!!!
        SENSE:The New Of Communication...................
    </h2>
    <div id="meet" style="width: 100%; height: 600px; margin: 0 auto;"></div>

    <script src="https://8x8.vc/external_api.js"></script>
    <script>


        const domain = "8x8.vc";

        // Use the exact same AppID as shown in your JaaS dashboard:
        const appID = "vpaas-magic-cookie-4950bf7a9bf84024a561d8269b0ecf8c";

        // Use the SAME token that worked in the browser
        const jwtToken = "";

        // Optional: you can give a custom room name
        const roomName = appID + "/SignMeetRoom";

        const options = {
            roomName: roomName,
            jwt: jwtToken,
            parentNode: document.querySelector('#meet'),
            configOverwrite: {
                prejoinPageEnabled: false
            },
            interfaceConfigOverwrite: {
                SHOW_JITSI_WATERMARK: false,
                SHOW_BRAND_WATERMARK: false,
                SHOW_POWERED_BY: false
            }
        };

        const api = new JitsiMeetExternalAPI(domain, options);

        function speakDynamically(baseText, langCode) {
            let encodedText = encodeURIComponent(baseText);

            // Calls our new *dynamic* endpoint
            let audioUrl = `/api/dynamic_tts/?text=${encodedText}&lang=${langCode}`;

            let audio = new Audio(audioUrl);
            audio.play().catch(e => console.error("Error playing audio:", e));
        }

        // --- Language setup ---
        // You just need the base message in English now
        const welcomeText = "Welcome to the meeting!";

        // Get the user's language from your Django context
        // Example: You passed 'user_lang': 'hi' in your context
        const userLanguage = '{{ user_lang|default:"en" }}';

        // --- Jitsi Initialization ---
        function startJitsiMeeting() {
            const domain = "8x8.vc";
            const myJwtToken = "{{ your_jwt_token_from_django_context }}";

            const options = {
                roomName: "YourConferenceRoomName",
                jwt: myJwtToken,
                parentNode: document.querySelector('#meet-container'),
                // ... other options
            };

            const api = new JitsiMeetExternalAPI(domain, options);

            api.addEventListener('videoConferenceJoined', () => {
                console.log('Local user joined. Requesting dynamic speech in:', userLanguage);

                // Call the function with the English text and target language
                speakDynamically(welcomeText, userLanguage);
            });
        }

        // Start the meeting (e.g., on window load or button click)
        window.onload = () => startJitsiMeeting();
    </script>

    <button id="chat-toggle-icon" class="chat-toggle-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" />
        </svg>
    </button>

    {% include 'partials/bot.html' %}

    <script src="{% static 'js/bot.js' %}"></script>
</body>

</html>